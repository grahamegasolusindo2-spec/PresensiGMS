<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Presensi Digital - Graha Mega Solusinya</title>
    <!-- Font Inter untuk tampilan modern -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library SheetJS untuk Export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #051650; /* Indigo Modern */
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10B981; /* Emerald */
            --danger: #EF4444; /* Red */
            --warning: #F59E0B; /* Amber */
            --bg-app: #F3F4F6; /* Abu-abu muda halus */
            --surface: #FFFFFF;
            --text-main: #111827;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-app); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        
        .hidden { display: none !important; }
        
        /* Container Mobile untuk Employee, Lebar untuk Admin */
        .container { max-width: 480px; margin: 0 auto; padding: 0 20px; width: 100%; }
        .container.admin { max-width: 1000px; } /* Admin butuh layar lebar */

        /* --- COMPONENTS --- */
        .card { background: var(--surface); border-radius: var(--radius-md); padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 14px 20px; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; display: inline-flex; }

        /* --- LOGIN VIEW --- */
        .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
        .login-card { width: 100%; text-align: center; }
        
        /* LOGO */
        .app-logo { 
            width: 120px; 
            height: auto; 
            margin: 0 auto 20px; 
            display: block; 
            object-fit: contain; 
            border-radius: 12px; 
        }
        
        /* --- HEADER PROFILE (EMPLOYEE) --- */
        .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
            color: white;
            padding: 30px 20px 50px; /* Extra padding bottom */
            border-radius: 0 0 30px 30px;
            margin-top: -20px; /* Pull to top */
            position: relative;
        }
        .profile-content { display: flex; align-items: center; gap: 15px; }
        .profile-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
        .profile-info h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; }
        .profile-info p { opacity: 0.9; font-size: 0.9rem; }
        
        /* --- RUNNING TEXT --- */
        .marquee-strip { background: #FEF3C7; color: #92400E; padding: 10px; border-radius: 12px; margin-top: -35px; position: relative; z-index: 10; box-shadow: var(--shadow); overflow: hidden; white-space: nowrap; font-size: 0.85rem; font-weight: 500; }
        .marquee-content { display: inline-block; animation: marquee 15s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- CLOCK BUTTONS --- */
        .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 24px 0; }
        .clock-btn { height: 120px; flex-direction: column; font-size: 1.1rem; border-radius: 20px; }
        .clock-icon { font-size: 2rem; margin-bottom: 8px; }
        
        /* --- HISTORY LIST --- */
        .history-item { display: flex; gap: 15px; padding: 16px 0; border-bottom: 1px solid #f3f4f6; }
        .history-time { text-align: right; min-width: 60px; }
        .history-time span { font-weight: 700; color: var(--primary); font-size: 1rem; }
        .history-time small { color: var(--text-muted); font-size: 0.75rem; }
        .history-content { flex: 1; }
        .history-status { font-weight: 600; margin-bottom: 4px; font-size: 0.95rem; }
        .history-loc { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        
        /* --- ADMIN PANEL --- */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: var(--radius-md); border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }

        /* --- TABLES --- */
        .table-container { overflow-x: auto; background: white; border-radius: var(--radius-md); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #F9FAFB; text-align: left; padding: 12px 16px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }

        /* --- TABS --- */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 16px; border-radius: 50px; background: white; border: 1px solid var(--border); font-size: 0.9rem; font-weight: 500; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- FOOTER --- */
        .admin-footer {
            margin-top: 40px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #E5E7EB;
        }
        .admin-footer .brand-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #374151;
            margin: 0 0 4px 0;
        }
        .admin-footer .support-text {
            font-size: 0.75rem;
            color: #9CA3AF;
            letter-spacing: 0.5px;
            margin: 0;
        }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 24px; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- CAMERA --- */
        video { width: 100%; height: 250px; background: black; border-radius: 12px; object-fit: cover; transform: scaleX(-1); }
    </style>
</head>
<body>

    <!-- VIEW: LOGIN -->
    <section id="view-login" class="container">
        <div class="login-wrapper">
            <div class="login-card">
                <img src="https://i.imgur.com/xX4QN18.png" alt="Logo Perusahaan" class="app-logo">
                
                <h2 style="margin-bottom: 8px;">Selamat Datang</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Sistem Presensi Digital GMS</p>
                
                <div class="card" style="text-align: left; box-shadow: var(--shadow);">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Nama Lengkap</label>
                        <input type="text" id="login-name" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem;" placeholder="Contoh: Budi Santoso">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">ID Pengguna</label>
                        <input type="text" id="login-id" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem;" placeholder="ID Anda">
                    </div>
                    <button onclick="app.login()" class="btn btn-primary">Masuk Aplikasi</button>
                </div>
                <p style="margin-top: 20px; font-size: 0.8rem; color: var(--text-muted);">
                    *Admin gunakan ID <b>gms001</b>
                </p>
            </div>
        </div>

        <!-- FOOTER LOGIN -->
        <div class="admin-footer">
            <p class="brand-name">Graha Mega Solusindo</p>
            <p class="support-text">supported by: Klase Auto Graha</p>
        </div>
    </section>

    <!-- VIEW: EMPLOYEE -->
    <section id="view-employee" class="container hidden">
        <!-- Header Profile -->
        <div class="profile-header">
            <div class="profile-content">
                <img id="emp-avatar" src="" class="profile-avatar">
                <div class="profile-info">
                    <h2 id="emp-name">Nama User</h2>
                    <p id="emp-role">Karyawan IT</p>
                </div>
                <div style="margin-left: auto;">
                    <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">ID: <span id="emp-id">123</span></span>
                </div>
            </div>
        </div>

        <!-- Running Text -->
        <div class="marquee-strip">
            <div class="marquee-content">
                ‚ö†Ô∏è Ingat! Clock In maksimal jam 09:00 WIB.  |  Pastikan Anda berada di dalam radius kantor saat absen.  |  Gunakan fitur Pengajuan jika tidak masuk kerja.
            </div>
        </div>

        <!-- Clock Actions -->
        <div class="clock-grid">
            <button onclick="app.openCamera('Masuk')" class="btn btn-success clock-btn">
                <span class="clock-icon">üì•</span>
                Clock In
            </button>
            <button onclick="app.openCamera('Pulang')" class="btn btn-danger clock-btn">
                <span class="clock-icon">üì§</span>
                Clock Out
            </button>
        </div>

        <!-- Status GPS -->
        <div class="card" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px;">
            <div id="gps-dot" style="width: 10px; height: 10px; background: #ccc; border-radius: 50%;"></div>
            <div style="flex: 1;">
                <div style="font-size: 0.9rem; font-weight: 600;" id="gps-status-text">Menunggu Lokasi...</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);" id="gps-coords">Lat: -, Lng: -</div>
            </div>
        </div>

        <!-- Pengajuan & Menu -->
        <div class="card" style="padding: 0;">
            <div onclick="document.getElementById('sub-form').classList.toggle('hidden')" style="padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6;">
                <span style="font-weight: 600;">üìÑ Ajukan Izin / Sakit</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-form" class="hidden" style="padding: 20px; background: #f9fafb;">
                <select id="sub-type" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
                    <option>Sakit</option>
                    <option>Izin</option>
                    <option>Cuti</option>
                    <option value="Luar Kota">Luar Kota</option>
                </select>

                <!-- Input File Bukti (DIKELUARKAN DARI SELECT) -->
                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Bukti (Opsional)</label>
                <input type="file" id="sub-file-proof" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">

                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Tanggal Pengajuan</label>
                <input type="date" id="sub-date" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">

                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Keterangan (Min 100 Karakter)</label>
                <textarea id="sub-desc" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem;" placeholder="Tulis keterangan... (Sudah 0/100)" oninput="this.nextElementSibling.textContent = this.value.length + '/100 Karakter'"></textarea>
                <small style="color: var(--text-muted); display:block; margin-bottom:10px;" id="char-count">0/100 Karakter</small>
                
                <button onclick="app.submitPengajuan()" class="btn btn-primary btn-sm">Kirim Pengajuan</button>
                <button onclick="app.sendWAAdmin()" class="btn btn-outline btn-sm" style="margin-top: 5px; border-color: #25D366; color: #25D366;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right:5px;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    Kirim Notif ke WA Admin
                </button>
            </div>
        </div>

        <!-- History -->
        <h3 style="margin: 20px 0 12px; font-size: 1.1rem;">Riwayat & Status</h3>
        <div class="card" style="padding-top: 10px;">
            <!-- Tab Navigasi -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px;">
                <button id="tab-hist-absen" onclick="app.switchHistory('absen')" class="btn btn-sm" style="background: var(--primary); color: white; border: none; flex: 1;">Riwayat Absen</button>
                <button id="tab-hist-sub" onclick="app.switchHistory('pengajuan')" class="btn btn-sm" style="background: white; color: var(--text-muted); border: 1px solid var(--border); flex: 1;">Riwayat Pengajuan</button>
            </div>

            <!-- Konten: Riwayat Absen -->
            <div id="view-absen">
                <div id="history-list-absen">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem;">Memuat riwayat absen...</div>
                </div>
            </div>

            <!-- Konten: Riwayat Pengajuan -->
            <div id="view-pengajuan" class="hidden">
                <div id="history-list-sub">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem;">Belum ada pengajuan.</div>
                </div>
            </div>
        </div>

        <button onclick="app.logout()" class="btn btn-outline" style="border-color: #fee2e2; color: var(--danger);">Keluar Aplikasi</button>
    </section>

    <!-- VIEW: ADMIN -->
    <section id="view-admin" class="container admin hidden">
        <div class="admin-header">
            <div>
                <h2 style="font-size: 1.5rem;">Dashboard Admin</h2>
                <p style="color: var(--text-muted);">Halo, Admin HR</p>
            </div>
            <button onclick="app.logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="stat-total">0</div>
                <div class="stat-label">Total Karyawan</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="stat-present">0</div>
                <div class="stat-label" style="color: var(--success);">Hadir Hari Ini</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="stat-sub">0</div>
                <div class="stat-label" style="color: var(--warning);">Pengajuan Pending</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-btn active" onclick="app.switchAdminTab('attendance', this)">Rekap Absen</div>
            <div class="tab-btn" onclick="app.switchAdminTab('employees', this)">Kelola Karyawan</div>
            <div class="tab-btn" onclick="app.switchAdminTab('submissions', this)">Pengajuan</div>
        </div>

        <!-- Tab Content -->
        <div id="tab-attendance">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 16px; background: #f9fafb; display: flex; gap: 10px; border-bottom: 1px solid var(--border);">
                    <input type="date" id="filter-date" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px;">
                    <button onclick="app.exportExcel('attendance')" class="btn btn-success btn-sm">üì• Excel</button>
                </div>
                <div class="table-container">
                    <table id="admin-att-table">
                        <thead><tr><th>Waktu</th><th>Nama</th><th>Tipe</th><th>Lokasi</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-employees" class="hidden">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 16px; background: #f9fafb; display: flex; gap: 10px; border-bottom: 1px solid var(--border);">
                    <button onclick="app.showAddUserModal()" class="btn btn-primary btn-sm">+ Tambah</button>
                    <button onclick="document.getElementById('import-file').click()" class="btn btn-outline btn-sm">Import CSV</button>
                    <input type="file" id="import-file" accept=".csv" style="display:none" onchange="app.handleImport(this)">
                    <button onclick="app.exportExcel('employees')" class="btn btn-success btn-sm">Download Data</button>
                </div>
                <div class="table-container">
                    <table id="admin-emp-table">
                        <thead><tr><th>ID</th><th>Nama</th><th>Role</th><th>GPS</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-submissions" class="hidden">
            <div class="card" style="padding: 0;">
                <div class="table-container">
                    <table id="admin-sub-table">
                        <thead><tr><th>Tgl</th><th>Nama</th><th>Tipe</th><th>Alasan</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FOOTER ADMIN -->
        <div class="admin-footer">
            <p class="brand-name">Graha Mega Solusinya</p>
            <p class="support-text">supported by: Klase Auto Graha</p>
        </div>
    </section>

    <!-- MODAL CAMERA -->
    <div id="camera-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 15px;">Ambil Foto Selfie</h3>
            <video id="webcam" autoplay playsinline></video>
            <p id="cam-msg" style="color: var(--text-muted); margin: 10px 0;">Kamera Aktif...</p>
            <div style="display: flex; gap: 10px;">
                <button onclick="app.closeCamera()" class="btn btn-outline">Batal</button>
                <button onclick="app.takePhoto()" class="btn btn-primary">Ambil Foto</button>
            </div>
        </div>
    </div>

    <!-- MODAL ADD USER -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Tambah Karyawan</h3>
            <input id="new-id" placeholder="ID Baru" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="new-name" placeholder="Nama" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <select id="new-role" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;"><option value="employee">Karyawan</option><option value="admin">Admin</option></select>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="document.getElementById('user-modal').classList.remove('active')" class="btn btn-outline">Batal</button>
                <button onclick="app.saveNewUser()" class="btn btn-primary">Simpan</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // GANTI URL_INI DENGAN URL WEB APP GOOGLE SCRIPT ANDA
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUt1plW8VqOEsmLMPX9XEfefchygAu9gxAnpqIOJp_MEl9pvJfPpxbtKRHAlE1pFVM/exec
        const app = {
            data: { users: [], currentUser: null, currentLocation: null, cameraStream: null, currentAction: null },

            init: function() {
                const session = sessionStorage.getItem('presensi_pro_session');
                if (session) {
                    this.data.currentUser = JSON.parse(session);
                    this.loadFromSheet();
                }
            },

            // --- AUTH ---
            login: function() {
                const name = document.getElementById('login-name').value;
                const id = document.getElementById('login-id').value;
                
                // Mock login logic
                let role = 'employee';
                if(id === 'gms001') role = 'admin';
                
                // Cek data users
                let user = this.data.users.find(u => u.id === id);
                
                if(user || (role === 'admin' && name === 'Admin')) {
                    if(!user) user = {id: id, name: name, role: role, locName: 'HQ', gpsMode: 'bebas'};
                    this.data.currentUser = user;
                    sessionStorage.setItem('presensi_pro_session', JSON.stringify(user));
                    this.route();
                } else {
                    alert("User tidak ditemukan!");
                }
            },

            logout: function() { sessionStorage.clear(); location.reload(); },

            route: function() {
                document.getElementById('view-login').classList.add('hidden');
                if (this.data.currentUser.role === 'admin') {
                    document.getElementById('view-admin').classList.remove('hidden');
                    this.renderAdminStats();
                    this.renderAdminEmployees();
                } else {
                    document.getElementById('view-employee').classList.remove('hidden');
                    this.initEmployeeDashboard();
                }
            },

            // --- DATA & GPS ---
            loadFromSheet: function() {
                if(!APP_SCRIPT_URL.includes('http')) return; 
                fetch(`${APP_SCRIPT_URL}?action=getUsers`)
                .then(r => r.json()).then(data => { this.data.users = data; if(this.data.currentUser) this.route(); });
            },

            initEmployeeDashboard: function() {
                const u = this.data.currentUser;
                document.getElementById('emp-name').textContent = u.name;
                document.getElementById('emp-id').textContent = u.id;
                document.getElementById('emp-avatar').src = `https://picsum.photos/seed/${u.id}/200/200`;
                this.getLocation();
            },

            getLocation: function() {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        this.data.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        document.getElementById('gps-status-text').textContent = "Lokasi Terkunci ‚úÖ";
                        document.getElementById('gps-coords').textContent = `Lat: ${this.data.currentLocation.lat.toFixed(4)}, Lng: ${this.data.currentLocation.lng.toFixed(4)}`;
                        document.getElementById('gps-dot').style.background = "var(--success)";
                    });
                }
            },
            
            // --- PENGAJUAN & WA (FINAL VERSION) ---
            submitPengajuan: function() {
                const type = document.getElementById('sub-type').value;
                const desc = document.getElementById('sub-desc').value;
                const date = document.getElementById('sub-date').value;
                const fileInput = document.getElementById('sub-file-proof');
                
                let proofData = null; // Default null jika tidak ada foto

                // Fungsi untuk mengirim data (dipanggil jika file selesai dibaca atau tidak ada file)
                const processSubmission = () => {
                    // 1. Validasi Tanggal
                    if(!date) {
                        alert("Harap pilih tanggal pengajuan!");
                        return;
                    }

                    // 2. Validasi Minimal 100 Karakter
                    if(desc.length < 100) {
                        alert(`Keterangan terlalu pendek! Minimal 100 karakter.\nSaat ini hanya: ${desc.length} karakter.`);
                        return;
                    }

                    // 3. Kirim Data ke Sheet
                    const payload = {
                        action: 'submission',
                        userId: this.data.currentUser.id,
                        name: this.data.currentUser.name,
                        subType: type,
                        desc: desc,
                        date: date,
                        photoProof: proofData // Kirim foto (jika ada)
                    };

                    fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        alert("Pengajuan Terkirim!");
                        document.getElementById('sub-form').classList.add('hidden');
                        // Reset Form
                        document.getElementById('sub-desc').value = "";
                        document.getElementById('sub-file-proof').value = "";
                        document.getElementById('char-count').textContent = "0/100 Karakter";
                        this.loadMySubmissions();
                    })
                    .catch(err => alert("Gagal kirim: " + err));
                };

                // Jika ada file yang dipilih, baca dulu (compress lalu kirim)
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Di sini bisa ditambahkan fungsi kompresi jika file terlalu besar
                        proofData = e.target.result; // Base64 string
                        processSubmission();
                    };
                    reader.readAsDataURL(file);
                } else {
                    processSubmission(); // Jika tidak ada foto, langsung kirim
                }
            },

            sendWAAdmin: function() {
                // 1. Cari Data Admin di List Users
                // Script backend mengirim role 'admin'
                const admin = this.data.users.find(u => u.role === 'admin');
                
                if (!admin || !admin.wa) {
                    alert("Nomor WA Admin belum tersedia di database. Hubungi Admin manual.");
                    return;
                }

                // 2. Ambil Data Form
                const u = this.data.currentUser;
                const type = document.getElementById('sub-type').value;
                const date = document.getElementById('sub-date').value;
                const desc = document.getElementById('sub-desc').value;

                // 3. Buat Pesan WA Otomatis
                const text = `*PENGAJUAN BARU*%0A%0A` +
                            `Nama: ${u.name} (ID: ${u.id})%0A` +
                            `Tipe: ${type}%0A` +
                            `Tanggal: ${date}%0A` +
                            `Keterangan: ${desc}%0A%0A` +
                            `Mohon segera lihat dan proses di Dashboard Admin. Terima kasih.`;
                
                // 4. Buka WhatsApp
                // Format link WA: https://wa.me/NOMOR?text=PESAN
                window.open(`https://wa.me/${admin.wa}?text=${text}`, '_blank');
            },

            // --- ATTENDANCE ---
            openCamera: function(type) {
                this.currentAction = type;
                document.getElementById('camera-modal').classList.add('active');
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    this.data.cameraStream = stream;
                    document.getElementById('webcam').srcObject = stream;
                });
            },

            closeCamera: function() {
                if(this.data.cameraStream) this.data.cameraStream.getTracks().forEach(t => t.stop());
                document.getElementById('camera-modal').classList.remove('active');
            },

            takePhoto: function() {
                const video = document.getElementById('webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                const photo = canvas.toDataURL('image/jpeg', 0.5);
                
                // Send Data Logic
                const payload = {
                    action: 'attendance', userId: this.data.currentUser.id, name: this.data.currentUser.name,
                    clockType: this.currentAction, photo: photo, timestamp: new Date().toISOString(),
                    lat: this.data.currentLocation ? this.data.currentLocation.lat : 0,
                    lng: this.data.currentLocation ? this.data.currentLocation.lng : 0
                };
                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(() => {
                    alert("Absen Berhasil!");
                    this.closeCamera();
                    this.loadMyHistory();
                });
            },

            // --- HISTORY TABS (ABSEN / PENGAJUAN) ---
            switchHistory: function(type) {
                const btnAbsen = document.getElementById('tab-hist-absen');
                const btnSub = document.getElementById('tab-hist-sub');
                const viewAbsen = document.getElementById('view-absen');
                const viewSub = document.getElementById('view-pengajuan');

                if (type === 'absen') {
                    btnAbsen.style.background = 'var(--primary)';
                    btnAbsen.style.color = 'white';
                    btnSub.style.background = 'white';
                    btnSub.style.color = 'var(--text-muted)';
                    
                    viewAbsen.classList.remove('hidden');
                    viewSub.classList.add('hidden');
                } else {
                    btnSub.style.background = 'var(--primary)';
                    btnSub.style.color = 'white';
                    btnAbsen.style.background = 'white';
                    btnAbsen.style.color = 'var(--text-muted)';
                    
                    viewSub.classList.remove('hidden');
                    viewAbsen.classList.add('hidden');
                    
                    this.loadMySubmissions(); // Load data pengajuan
                }
            },

            loadMyHistory: function() {
                const list = document.getElementById('history-list-absen');
                list.innerHTML = `
                    <div class="history-item">
                        <div class="history-time"><span>08:15</span><small>AM</small></div>
                        <div class="history-content">
                            <div class="history-status">‚úÖ Clock In</div>
                            <div class="history-loc">üìç Kantor Pusat</div>
                        </div>
                    </div>
                    <div class="history-item">
                        <div class="history-time"><span>17:00</span><small>PM</small></div>
                        <div class="history-content">
                            <div class="history-status">üî¥ Clock Out</div>
                            <div class="history-loc">üìç Kantor Pusat</div>
                        </div>
                    </div>
                `;
            },

            // --- LOAD REAL DATA PENGAJUAN ---
            loadMySubmissions: function() {
                if(!APP_SCRIPT_URL.includes('http')) return;
                
                const list = document.getElementById('history-list-sub');
                list.innerHTML = `<div style="text-align:center; padding:20px;">Memuat data...</div>`;

                fetch(`${APP_SCRIPT_URL}?action=getSubmissions`)
                .then(r => r.json())
                .then(data => {
                    if (data.length === 0) {
                        list.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.9rem;">Belum ada pengajuan.</div>`;
                        return;
                    }

                    // Filter hanya milik user yang login
                    const mySubs = data.filter(s => s.userId === this.data.currentUser.id);
                    
                    list.innerHTML = mySubs.map(s => {
                        const dateObj = new Date(s.id);
                        const dateStr = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                        const statusColor = s.status === 'Pending' ? 'orange' : (s.status === 'Disetujui' ? 'green' : 'red');
                        
                        return `
                        <div class="history-item">
                            <div class="history-time"><span>${dateStr}</span></div>
                            <div class="history-content">
                                <div class="history-status">${s.type}</div>
                                <div class="history-loc">Status: <span style="color:${statusColor}">${s.status}</span></div>
                            </div>
                        </div>
                        `;
                    }).join('');
                })
                .catch(err => {
                    console.error(err);
                    list.innerHTML = `<div style="text-align:center; color:red;">Gagal memuat data.</div>`;
                });
            },

            // --- ADMIN ---
            switchAdminTab: function(tab, el) {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                ['attendance','employees','submissions'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            },

            renderAdminStats: function() {
                document.getElementById('stat-total').textContent = this.data.users.filter(u=>u.role==='employee').length || "12";
                document.getElementById('stat-present').textContent = "10";
                document.getElementById('stat-sub').textContent = "2";
            },

            renderAdminEmployees: function() {
                const tbody = document.querySelector('#admin-emp-table tbody');
                tbody.innerHTML = this.data.users.map(u => `
                    <tr><td>${u.id}</td><td>${u.name}</td><td>${u.role}</td><td>${u.gpsMode}</td><td><button class="btn btn-danger btn-sm">Hapus</button></td></tr>
                `).join('');
            },

            showAddUserModal: function() { document.getElementById('user-modal').classList.add('active'); },
            
            saveNewUser: function() {
                alert("Simpan Data User ke Sheet...");
                document.getElementById('user-modal').classList.remove('active');
            },
            
            exportExcel: function(type) {
                alert("Mengunduh file Excel...");
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>

