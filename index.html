<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Presensi GMS - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- MODERN & PROFESSIONAL UI SYSTEM --- */
    :root {
        --primary: #0f172a; /* Slate Dark - Lebih elegan */
        --primary-hover: #1e293b;
        --primary-light: #334155;
        --accent: #3b82f6; /* Biru Cerah untuk Aksi */
        --success: #10b981;
        --success-light: #d1fae5;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --warning: #f59e0b;
        
        --bg-app: #f8fafc; /* Abu sangat muda bersih */
        --bg-pattern: radial-gradient(#e2e8f0 1px, transparent 1px); /* Pola titik halus */
        --surface: #ffffff;
        
        --text-main: #1e293b;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        
        --border: #e2e8f0;
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --glass-bg: rgba(255, 255, 255, 0.85);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
        background-color: var(--bg-app); 
        background-image: var(--bg-pattern);
        background-size: 24px 24px;
        color: var(--text-main); 
        font-family: 'Inter', sans-serif; 
        padding-bottom: 100px; 
        -webkit-font-smoothing: antialiased;
    }
    
    .hidden { display: none !important; }
    
    /* LAYOUT & CONTAINERS */
    .container { max-width: 480px; margin: 0 auto; padding: 0 24px; width: 100%; }
    .container.admin { max-width: 1100px; }

    /* CARDS - Glassy Look */
    .card { 
        background: var(--surface); 
        border-radius: var(--radius-md); 
        padding: 24px; 
        box-shadow: var(--shadow-sm); 
        margin-bottom: 24px; 
        border: 1px solid var(--border); /* Border tipis profesional */
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    /* BUTTONS - Modern Pill Shape */
    .btn { 
        padding: 14px 24px; 
        border: none; 
        border-radius: 12px; /* Bentuk Pill */
        font-weight: 600; 
        font-size: 0.95rem; 
        letter-spacing: 0.025em; /* Spacing huruf profesional */
        cursor: pointer; 
        width: 100%; 
        transition: all 0.2s ease; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active { transform: scale(0.96); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
    
    .btn-primary { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); 
    }
    
    .btn-success { 
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); 
    }
    
    .btn-danger { 
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); 
        color: white; 
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); 
    }
    
    .btn-outline { 
        background: white; 
        border: 1px solid var(--border); 
        color: var(--text-main); 
        box-shadow: none; 
    }
    .btn-outline:hover { background: #f1f5f9; }
    
    .btn-sm { padding: 8px 16px; font-size: 0.8rem; width: auto; display: inline-flex; height: 36px; }
    .btn-print { background: var(--text-main); color: white; width: auto; box-shadow: none; }

    /* INPUTS - Floating Style */
    input, select, textarea { 
        width: 100%; 
        padding: 12px 16px; 
        border: 1px solid var(--border); 
        border-radius: 10px; 
        margin-bottom: 12px; 
        font-size: 0.95rem; 
        background: #fdfdfd;
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.01);
    }
    
    input:focus, select:focus, textarea:focus { 
        border-color: var(--accent); 
        outline: none; 
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        background: #fff;
    }
    
    label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-main); margin-bottom: 6px; letter-spacing: 0.025em; }

    /* --- LOGIN SCREEN REDESIGN --- */
    .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; }
    .login-card { 
        width: 100%; 
        max-width: 380px; 
        text-align: center; 
        background: white; 
        padding: 40px 30px; 
        border-radius: 30px; 
        box-shadow: var(--shadow-float); 
        border: 1px solid var(--border);
    }
    .app-logo { 
        width: 80px; 
        height: 80px; 
        margin: 0 auto 24px; 
        display: block; 
        object-fit: contain; 
        border-radius: 20px; 
        box-shadow: var(--shadow-md);
    }
    .login-footer { margin-top: 40px; text-align: center; color: var(--text-light); font-size: 0.85rem; }
    .login-footer .brand-name { font-weight: 700; color: var(--primary); font-size: 1.1rem; margin-bottom: 4px; }

    /* --- PROFILE HEADER --- */
    .profile-header { 
        background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%); 
        color: white; 
        padding: 40px 24px 60px; /* Padding lebih besar */
        border-radius: 0 0 40px 40px; 
        margin-top: -20px; 
        box-shadow: var(--shadow-md);
    }
    
    .profile-content { display: flex; align-items: center; gap: 16px; }
    
    .profile-avatar-icon { 
        width: 64px; height: 64px; border-radius: 50%; 
        background: rgba(255, 255, 255, 0.2); 
        display: flex; align-items: center; justify-content: center; 
        border: 2px solid rgba(255,255,255,0.5);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* --- CLOCK WIDGET (GLASSMORPHISM) --- */
    .clock-widget { 
        background: var(--glass-bg); 
        backdrop-filter: blur(16px); /* Efek kaca blur */
        -webkit-backdrop-filter: blur(16px);
        margin-top: -30px; 
        margin-bottom: 30px; 
        padding: 20px; 
        border-radius: 20px; 
        text-align: center; 
        box-shadow: var(--shadow-float); 
        position: relative; 
        z-index: 10;
        border: 1px solid rgba(255, 255, 255, 0.6);
    }

    #date-display { font-size: 0.8rem; font-weight: 600; color: var(--text-light); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
    #time-display { font-size: 2.5rem; font-weight: 800; color: var(--primary); line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: -1px; }

    /* --- CLOCK BUTTONS --- */
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 30px; }
    .clock-btn { height: 110px; flex-direction: column; font-size: 1rem; font-weight: 600; border-radius: 20px; }
    .clock-icon { font-size: 2rem; margin-bottom: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
     
    /* --- 1. RUNNING TEXT (MARQUEE) --- */
    .marquee-strip {
        background: #fffbeb; /* Kuning muda peringatan */
        color: #92400e;
        padding: 12px 0;
        border-radius: 12px;
        margin: 16px 0;
        font-size: 0.85rem;
        font-weight: 600;
        overflow: hidden;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #fcd34d;
        position: relative;
    }
    
    .marquee-content {
        display: inline-block;
        padding-left: 100%;
        animation: marquee 20s linear infinite;
    }
    
    @keyframes marquee { 
        0% { transform: translateX(0); } 
        100% { transform: translateX(-100%); } 
    }
     
        /* --- 1. UPDATE ADMIN LAYOUT (DESKTOP LOOK) --- */
    .container.admin { 
        max-width: 95%; /* Lebar hampir penuh untuk layar lebar */
        margin: 20px auto; /* Margin tipis atas bawah */
        padding: 0; /* Padding 0 agar melebar pinggir */
        width: 100%;
    }

    /* --- 2. UPDATE TOMBOL TAB (RICHER COLORS) --- */
    /* Default style tombol Tab (Tidak Aktif) */
    .tab-btn { 
        background: white; 
        border: 1px solid var(--border); 
        color: var(--text-muted); 
        padding: 10px 24px; /* Lebih lebar untuk desktop */
    }
    
    /* Saat Hover */
    .tab-btn:hover { 
        background: #f8fafc; 
        color: var(--primary); 
        border-color: var(--primary);
    }

    /* Saat Aktif (Warna Berubah Drastis) */
    .tab-btn.active {
        background: var(--primary) !important; /* Warna Utama */
        color: white !important;
        border-color: var(--primary) !important;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3) !important; /* Bayangan lebih tebal */
        font-weight: 700;
        transform: translateY(-2px); /* Sedikit naik ke atas */
    }

    /* Overwrite warna spesifik tab saat aktif (opsional agar lebih kaya warna) */
    .tab-emp.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; border-color: #059669 !important; } /* Hijau */
    .tab-att.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; border-color: #2563eb !important; } /* Biru */
    .tab-sub.active { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; border-color: #d97706 !important; } /* Orange */
    
    /* --- 2. TOMBOL ADMIN BERWARNA (RICHER COLORS) --- */
    /* Saat tombol Aktif */
    .tab-btn.active {
        color: white !important;
        border-color: transparent !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    /* Warna spesifik per tab */
    .tab-emp.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); } /* Hijau */
    .tab-att.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); } /* Biru */
    .tab-sub.active { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); } /* Orange */
    
    /* --- TABLES & LISTS --- */
    .table-container { overflow-x: auto; background: white; border-radius: var(--radius-md); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f8fafc; text-align: left; padding: 14px 16px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fdfdfd; } /* Hover effect */

    /* History Items */
    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
    .history-status { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
    .history-loc { font-size: 0.8rem; color: var(--text-light); display: flex; align-items: center; gap: 4px; }

    /* --- BADGES & TAGS --- */
    .badge { display: inline-block; padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge-success { background: var(--success-light); color: #065f46; }
    .badge-danger { background: var(--danger-light); color: #991b1b; }
    .badge-warning { background: #fef3c7; color: #92400e; }

    /* --- ADMIN DASHBOARD --- */
    .admin-header { display: flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid var(--border); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 24px; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; box-shadow: var(--shadow-sm); }
    .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; line-height: 1; }
    .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

    .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .filter-bar input, .filter-bar select { width: auto; min-width: 130px; margin-bottom: 0; font-size: 0.85rem; padding: 8px 12px; }

    .tabs { display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 4px; }
    .tab-btn { padding: 10px 20px; border-radius: 50px; background: white; border: 1px solid var(--border); font-size: 0.85rem; font-weight: 600; color: var(--text-muted); white-space: nowrap; cursor: pointer; transition: all 0.2s; }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }

    /* --- MODALS --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-box { background: white; width: 95%; max-width: 500px; border-radius: 24px; padding: 32px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-float); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* --- TOAST --- */
    #toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    .toast { background: white; padding: 14px 24px; border-radius: 12px; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 12px; min-width: 300px; border-left: 5px solid var(--primary); transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; font-size: 0.9rem; font-weight: 500; }
    .toast.show { transform: translateX(0); }
    .toast.error { border-left-color: var(--danger); }
    .toast-icon { font-size: 1.2rem; }

    video { width: 100%; height: 280px; background: black; border-radius: 16px; object-fit: cover; transform: scaleX(-1); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    .input-group { display: flex; gap: 10px; }
    
    .csv-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; line-height: 1.5; background: #f1f5f9; padding: 12px; border-radius: 12px; border: 1px dashed var(--border); }

    /* --- ACCORDION --- */
    .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #f1f5f9; font-weight: 600; color: var(--text-main); transition: color 0.2s; }
    .accordion-header:hover { color: var(--primary); }
    .accordion-body { padding: 20px 0; background: transparent; } /* Background transparan */

    /* --- THUMBNAILS --- */
    .thumb-img { width: 56px; height: 56px; object-fit: cover; border-radius: 12px; cursor: pointer; border:1px solid var(--border); transition: 0.2s; }
    .thumb-img:hover { transform: scale(1.05); border-color: var(--accent); }

    /* --- PRINT --- */
    @media print {
        body * { visibility: hidden; }
        .print-area, .print-area * { visibility: visible; }
        .print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; }
        .no-print { display: none !important; }
        .table-container { border: none; }
        table { width: 100%; font-size: 10pt; border: 1px solid #000; }
        th, td { border: 1px solid #000; padding: 6px; white-space: normal; }
    }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- VIEW: LOGIN -->
        <section id="view-login" class="container">
        <div class="login-wrapper">
            <div class="login-card">
                <img src="https://i.imgur.com/xX4QN18.png" alt="Logo Perusahaan" class="app-logo">
                
                <h2 style="margin-bottom: 8px; color: var(--primary);">Sistem Presensi GMS</h2>
                <p style="color: var(--text-muted); margin-bottom: 32px; font-size: 0.9rem;">Selamat Datang Kembali</p>
                
                <label>Nama Lengkap</label>
                <input type="text" id="login-name" placeholder="Masukkan Nama Anda" autocomplete="off">
                
                <label style="margin-top:16px;">ID Pengguna</label>
                <div style="position: relative;">
                    <input type="password" id="login-id" placeholder="Masukkan ID" style="padding-right: 45px;" autocomplete="off">
                    <div onclick="app.togglePassword()" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);">
                        <svg id="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg id="eye-off-icon" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    </div>
                </div>

                <button onclick="app.login()" class="btn btn-primary" style="margin-top:24px; width:100%;">Masuk Aplikasi</button>
            </div>

            <div class="login-footer">
                <p class="brand-name">Graha Mega Solusindo</p>
                <p class="support-text">supported by : Klase Auto Graha</p>
            </div>
        </div>
    </section>

    <!-- VIEW: EMPLOYEE -->
    <section id="view-employee" class="container hidden">
        <div class="profile-header">
            <div class="profile-content">
                <div class="profile-avatar-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <div>
                    <h2 id="emp-name">Nama User</h2>
                    <small id="emp-role">Karyawan</small>
                </div>
            </div>
        </div>
        <div class="clock-widget">
            <div id="date-display">Senin, 1 Januari 2024</div>
            <div id="time-display">00:00:00</div>
        </div>

        <div class="card" style="margin-top:-15px; padding:10px 20px; display:flex; align-items:center; gap:10px;">
            <div id="gps-dot" style="width:10px; height:10px; background:#ccc; border-radius:50%;"></div>
            <div style="flex:1;">
                <div id="gps-status-text" style="font-size:0.85rem; font-weight:600;">Mencari Lokasi...</div>
                <div id="gps-coords" style="font-size:0.75rem; color:var(--text-muted);">Lat: -, Lng: -</div>
            </div>
        </div>

        <div id="gps-rule-info" class="hidden" style="background:#e0e7ff; color:#3730a3; padding:10px 15px; border-radius:8px; margin-bottom:15px; font-size:0.85rem; border:1px solid #c7d2fe;">
            ‚ÑπÔ∏è Anda harus berada di radius <span id="rule-radius">0</span>m dari <span id="rule-loc">Lokasi</span>
        </div>
        <!-- RUNNING TEXT (MARQUEE) -->
        <div class="marquee-strip">
            <div class="marquee-content">
                ‚ö†Ô∏è Jangan Lupa Presensi / Jika tidak hadir gunakan tombol pengajuan &nbsp;&nbsp;&nbsp; ‚ö†Ô∏è Jangan Lupa Presensi / Jika tidak hadir gunakan tombol pengajuan
            </div>
        </div>
        <div class="clock-grid">
            <button onclick="app.openCamera('Masuk')" class="btn btn-success clock-btn"><span style="font-size:1.5rem;">üì•</span>Clock In</button>
            <button onclick="app.openCamera('Pulang')" class="btn btn-danger clock-btn"><span style="font-size:1.5rem;">üì§</span>Clock Out</button>
        </div>

        <!-- FORM PENGAJUAN (Dengan Upload Bukti) -->
        <div class="card" style="padding: 0;">
            <div class="accordion-header" onclick="document.getElementById('sub-form').classList.toggle('hidden')">
                <span style="font-weight:600;">üìÑ Ajukan Izin / Sakit</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-form" class="hidden accordion-body">
                <label>Jenis Pengajuan</label>
                <select id="sub-type">
                    <option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Cuti">Cuti</option><option value="Luar Kota">Luar Kota</option>
                </select>
                
                <label>Tanggal Pengajuan</label>
                <input type="date" id="sub-date">

                <label>Keterangan (Min 100 Karakter)</label>
                <textarea id="sub-desc" style="font-size:0.9rem;" placeholder="Tulis keterangan..."></textarea>
                <small id="char-count" style="display:block; margin-bottom:10px; font-size:0.75rem; color:var(--text-muted);">0/100 Karakter</small>

                <!-- UPLOAD BUKTI -->
                <label>Upload Bukti (Foto/Optional)</label>
                <input type="file" id="sub-proof" accept="image/*">
                
                <button onclick="app.submitPengajuan()" class="btn btn-primary btn-sm">Kirim Pengajuan & WA Admin</button>
            </div>
        </div>

        <!-- RIWAYAT PENGAJUAN -->
        <div class="card" style="padding: 0;">
            <div class="accordion-header" onclick="document.getElementById('sub-history').classList.toggle('hidden')">
                <span style="font-weight:600;">üìë Riwayat Pengajuan</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-history" class="accordion-body">
                <div id="history-list-sub">
                    <div style="text-align:center; padding:10px; color:#999;">Memuat riwayat...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Riwayat Absen</h3>
            <div id="history-list-absen" style="margin-top:10px;">
                <div style="text-align:center; padding:10px; color:#999;">Belum ada data.</div>
            </div>
        </div>
        <button onclick="app.logout()" class="btn btn-outline">Keluar</button>
    </section>

    <!-- VIEW: ADMIN -->
    <section id="view-admin" class="container admin hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;" class="no-print">
            <h2>Admin Dashboard</h2>
            <button onclick="app.logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
        
        <!-- Tabs (Updated) -->
        <div style="display:flex; gap:10px; margin-bottom:24px;" class="no-print">
            <button onclick="app.switchTab('employees', this)" class="tab-btn tab-emp active">Data Karyawan</button>
            <button onclick="app.switchTab('attendance', this)" class="tab-btn tab-att">Rekap Absen</button>
            <button onclick="app.switchTab('submissions', this)" class="tab-btn tab-sub">Pengajuan</button>
            <button onclick="app.refreshData()" class="btn btn-primary btn-sm" style="width:auto;">üîÑ Refresh</button>
        </div>
        
        <!-- WIDGET STATISTIK (PASANG DI SINI) -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Karyawan</div>
                <div class="stat-val" id="stat-total">0</div>
                  </div>
                      <div class="stat-card">
                <div class="stat-label" style="color:var(--success);">Hadir Hari Ini</div>
                <div class="stat-val" id="stat-present" style="color:var(--success);">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--danger);">Belum Hadir</div>
                <div class="stat-val" id="stat-absent" style="color:var(--danger);">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" style="color:var(--warning);">Pengajuan Pending</div>
                <div class="stat-val" id="stat-sub" style="color:var(--warning);">0</div>
            </div>
        </div>

        <!-- Tab Employees -->
        <div id="tab-employees" class="print-area">
            <div class="card" style="padding:0; overflow:hidden;">
                <!-- Filters -->
                <div class="filter-bar no-print">
                    <input id="filter-emp-id" placeholder="Cari ID..." onkeyup="app.filterTable('admin-emp-table', 0, this.value)">
                    <input id="filter-emp-name" placeholder="Cari Nama..." onkeyup="app.filterTable('admin-emp-table', 1, this.value)">
                    <select id="filter-emp-loc" onchange="app.filterTable('admin-emp-table', 4, this.value)">
                        <option value="">Semua Lokasi</option>
                    </select>
                    <button onclick="window.print()" class="btn btn-print btn-sm">üñ®Ô∏è Print</button>
                </div>

                <div style="padding:15px; background:#f9fafb; border-bottom:1px solid #eee; display:flex; gap:10px; flex-wrap:wrap;" class="no-print">
                    <button onclick="app.showAddUserModal()" class="btn btn-primary btn-sm">+ Tambah Manual</button>
                    <button onclick="document.getElementById('import-csv').click()" class="btn btn-success btn-sm">üìÇ Import CSV</button>
                    <input type="file" id="import-csv" accept=".csv" style="display:none" onchange="app.handleImport(this)">
                </div>
                <div class="table-container">
                    <table id="admin-emp-table">
                        <thead><tr><th>ID</th><th>Nama</th><th>Role</th><th>Lokasi</th><th>Mode GPS</th><th>Lat, Lng</th><th>Radius</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Attendance -->
        <div id="tab-attendance" class="print-area hidden">
            <div class="card" style="padding:0; overflow:hidden;">
                 <!-- Filters -->
                 <div class="filter-bar no-print">
                    <input type="date" id="filter-att-date" onchange="app.refreshData()">
                    <input type="month" id="filter-att-month" onchange="app.refreshData()">
                    <button onclick="window.print()" class="btn btn-print btn-sm">  Print </button>
                </div>
                <div class="table-container">
                    <table id="admin-att-table">
                        <thead><tr><th>Waktu</th><th>Nama</th><th>Tipe</th><th>Lokasi (Lat, Lng)</th><th>Foto</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Submissions -->
        <div id="tab-submissions" class="print-area hidden">
            <div class="card" style="padding:0; overflow:hidden;">
                <!-- Filters -->
                <div class="filter-bar no-print">
                    <select id="filter-sub-status" onchange="app.refreshData()">
                        <option value="">Semua Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <button onclick="window.print()" class="btn btn-print btn-sm">üñ®Ô∏è Print</button>
                </div>
                <div class="table-container">
                    <table id="admin-sub-table">
                        <thead><tr><th>Tgl</th><th>Nama</th><th>Tipe</th><th>Keterangan</th><th>Bukti</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- MODALS -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="user-modal-title" style="margin-bottom:15px;">Tambah Karyawan</h3>
            <input type="hidden" id="old-id">
            <label>ID Karyawan</label><input type="text" id="new-id" readonly>
            <label>Nama Lengkap</label><input type="text" id="new-name">
            <label>Nomor WA</label><input type="text" id="new-wa">
            <label>Role</label>
            <select id="new-role"><option value="employee">Employee</option><option value="admin">Admin</option></select>
            
            <div style="margin:15px 0; border-top:1px solid #eee; padding-top:10px;">
                <label style="color:var(--primary);">Pengaturan Lokasi & GPS</label>
                <label>Nama Lokasi</label><input type="text" id="new-workloc">
                <label>Mode GPS</label>
                <select id="new-gpsmode" onchange="app.toggleGpsInputs()">
                    <option value="bebas">Bebas</option>
                    <option value="terkunci">Terkunci</option>
                </select>
                <div id="gps-inputs" class="hidden">
                    <label>Lat / Lng</label>
                    <div class="input-group">
                        <input type="text" id="new-lat" placeholder="Lat">
                        <input type="text" id="new-lng" placeholder="Lng">
                    </div>
                    <button onclick="app.getCurrentLocForAdmin()" class="btn btn-outline btn-sm" style="margin-bottom:10px;">üìç Pakai Lokasi Saya</button>
                    <label>Radius (m)</label><input type="number" id="new-radius" value="100">
                </div>
            </div>
            <div class="input-group">
                <button onclick="document.getElementById('user-modal').style.display='none'" class="btn btn-outline">Batal</button>
                <button id="btn-save-user" onclick="app.saveNewUser()" class="btn btn-primary">Simpan</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <h3 id="cam-action">Clock In</h3>
            <video id="webcam" autoplay playsinline></video>
            <div class="input-group" style="margin-top:15px;">
                <button onclick="app.closeCamera()" class="btn btn-outline">Batal</button>
                <button onclick="app.takePhoto()" class="btn btn-primary">Ambil & Kirim</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5BTolmP3ovePr1L7tHvmCjpaam0gylTAuulApMt8buTeWvQGgIX6zVca_Y4mL-sAq/exec'; 

        const $ = id => document.getElementById(id);

        function showToast(msg, type='success') {
            const c = $('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = type === 'success' ? '‚úÖ ' + msg : '‚ö†Ô∏è ' + msg;
            c.appendChild(el);
            setTimeout(() => el.classList.add('show'), 10);
            setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
        }

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); var d = R * c; return d * 1000;
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        const app = {
            data: { users: [], currentUser: null, currentLocation: null, stream: null },

            init: function() {
                const session = sessionStorage.getItem('gms_user');
                if(session) {
                    this.data.currentUser = JSON.parse(session);
                    this.fetchUsers(() => this.route());
                } else {
                    this.fetchUsers();
                }
            },

            togglePassword: function() {
                const input = $('login-id');
                if (input.type === "password") {
                    input.type = "text"; $('eye-icon').classList.add('hidden'); $('eye-off-icon').classList.remove('hidden');
                } else {
                    input.type = "password"; $('eye-icon').classList.remove('hidden'); $('eye-off-icon').classList.add('hidden');
                }
            },

            fetchUsers: function(cb) {
                if(!APP_SCRIPT_URL.includes('http')) return;
                fetch(`${APP_SCRIPT_URL}?action=getUsers`)
                .then(r => r.json())
                .then(res => {
                    this.data.users = res.users || [];
                    // Populate Filter Options
                    const locs = [...new Set(this.data.users.map(u => u.WorkLocation).filter(x=>x))];
                    $('filter-emp-loc').innerHTML = '<option value="">Semua Lokasi</option>' + locs.map(l=>`<option value="${l}">${l}</option>`).join('');
                    if(cb) cb();
                });
            },

            login: function() {
                const id = $('login-id').value.trim();
                const name = $('login-name').value.trim();
                if(!name || !id) { showToast("Nama dan ID harus diisi!", "error"); return; }
                const user = this.data.users.find(u => u.ID == id || u.id == id);
                if(user) {
                    if (user.Name.toLowerCase() === name.toLowerCase()) {
                        this.data.currentUser = user;
                        sessionStorage.setItem('gms_user', JSON.stringify(user));
                        showToast(`Selamat datang, ${user.Name}`);
                        this.route();
                    } else {
                        showToast("Nama tidak cocok dengan ID tersebut!", "error");
                    }
                } else {
                    showToast("ID Tidak ditemukan", "error");
                }
            },

            logout: function() { sessionStorage.clear(); location.reload(); },

            route: function() {
                $('view-login').classList.add('hidden');
                if(this.data.currentUser.Role === 'admin') {
                    $('view-admin').classList.remove('hidden');
                    this.renderEmployees();
                    this.refreshData();
                } else {
                    $('view-employee').classList.remove('hidden');
                    this.initEmployeeDashboard();
                }
            },

            // --- EMPLOYEE ---
            updateClock: function() {
                const now = new Date();
                document.getElementById('date-display').textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('time-display').textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            },

            initEmployeeDashboard: function() {
                const u = this.data.currentUser;
                $('emp-name').textContent = u.Name;
                $('emp-role').textContent = u.WorkLocation || "Karyawan";
                if(u.GPSMode === 'terkunci') {
                    $('gps-rule-info').classList.remove('hidden');
                    $('rule-radius').textContent = u.Radius;
                    $('rule-loc').textContent = u.WorkLocation || "Titik Terkunci";
                } else {
                    $('gps-rule-info').classList.add('hidden');
                }
                this.updateClock(); setInterval(() => this.updateClock(), 1000);
                this.getLocation();
                this.loadMySubmissions();
                this.checkTodayStatus();
            },
            
            getLocation: function() {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        this.data.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        $('gps-status-text').textContent = "Lokasi Terkunci ‚úÖ";
                        $('gps-coords').textContent = `${this.data.currentLocation.lat.toFixed(5)}, ${this.data.currentLocation.lng.toFixed(5)}`;
                        $('gps-dot').style.background = "var(--success)";
                    }, err => {
                        $('gps-status-text').textContent = "GPS Gagal ‚ùå";
                        $('gps-dot').style.background = "var(--danger)";
                    });
                }
            },

            // --- SUBMISSION (With Auto WA & Upload) ---
            submitPengajuan: function() {
                const type = $('sub-type').value;
                const date = $('sub-date').value;
                const desc = $('sub-desc').value;
                const fileInput = $('sub-proof');
                
                if(!date) return showToast("Harap pilih tanggal!", "error");
                if(desc.length > 100) return showToast(`Keterangan terlalu pendek! Max 100 kar. (${desc.length})`, "error");

                const process = (base64Proof) => {
                    const payload = {
                        action: 'submission',
                        userId: this.data.currentUser.ID,
                        name: this.data.currentUser.Name,
                        subType: type,
                        date: date,
                        desc: desc,
                        proof: base64Proof
                    };

                    fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                    .then(() => {
                        showToast("Pengajuan terkirim!");
                        $('sub-form').classList.add('hidden');
                        $('sub-desc').value = "";
                        $('sub-proof').value = "";
                        $('char-count').textContent = "0/100 Karakter";
                        this.loadMySubmissions();

                        // AUTO WA KIRIM PESAN
                        const admin = this.data.users.find(u => u.Role === 'admin');
                        if(admin && admin.WA) {
                            const text = `*PENGAJUAN BARU*%0A%0ANama: ${this.data.currentUser.Name}%0ATipe: ${type}%0ATgl: ${date}%0AIsi: ${desc}`;
                            window.open(`https://wa.me/${admin.WA}?text=${text}`, '_blank');
                        } else {
                            showToast("Admin WA tidak ditemukan", "error");
                        }
                    });
                };

                // Handle Upload
                if(fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => process(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    process(null);
                }
            },

            loadMySubmissions: function() {
                const list = $('history-list-sub');
                fetch(`${APP_SCRIPT_URL}?action=getData`).then(r=>r.json()).then(res => {
                    if(!res.submissions) return;
                    const mySubs = res.submissions.filter(s => s.UserID === this.data.currentUser.ID).reverse();
                    
                    if(mySubs.length === 0) { list.innerHTML = '<div style="text-align:center;">Belum ada pengajuan.</div>'; return; }

                    list.innerHTML = mySubs.map(row => {
                        let statusBadge = '';
                        let actionBtn = '';

                        // Contoh untuk History
                          if(row.Status === 'Pending') statusBadge = '<span class="badge badge-warning">‚è≥ Pending</span>';
                          if(row.Status === 'Approved') statusBadge = '<span class="badge badge-success">‚úÖ Disetujui</span>';
                          if(row.Status === 'Rejected') statusBadge = '<span class="badge badge-danger">‚ùå Ditolak</span>'; {
                          actionBtn = `<div style="margin-top:8px; background:#fee2e2; color:#991b1b; padding:8px; border-radius:4px; font-size:0.8rem;"><b>Alasan:</b> ${row.Reason || '-'}</div>`;
                        }

                        const proofLink = row.ProofURL && row.ProofURL !== "No Proof" ? `<a href="${row.ProofURL}" target="_blank" style="color:blue; font-size:0.8rem;">Lihat Bukti</a>` : '';

                        return `
                            <div style="padding:12px 0; border-bottom:1px solid #eee;">
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-muted);">
                                    <span>${row.Date}</span>
                                    ${statusBadge}
                                </div>
                                <div style="font-weight:600; margin:4px 0; color:var(--text-main);">${row.Type} ${proofLink}</div>
                                <div style="font-size:0.85rem; color:#555; line-height:1.4;">${row.Desc}</div>
                                ${actionBtn}
                            </div>
                        `;
                    }).join('');
                });
            },

            // --- ATTENDANCE (Drive Upload) ---
            openCamera: function(type) {
                this.currentAction = type;
                $('cam-action').textContent = type === 'Masuk' ? 'Clock In' : 'Clock Out';
                $('camera-modal').style.display = 'flex';
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
                .then(s => { this.data.stream = s; $('webcam').srcObject = s; });
            },

            closeCamera: function() {
                if(this.data.stream) this.data.stream.getTracks().forEach(t => t.stop());
                $('camera-modal').style.display = 'none';
            },

            takePhoto: function() {
                if(!this.data.currentLocation) return showToast("Aktifkan GPS dulu!", "error");
                if(this.data.currentUser.GPSMode === 'terkunci') {
                    const u = this.data.currentUser; const cur = this.data.currentLocation;
                    if(!u.TargetLat || !u.TargetLng) { showToast("Koordinat kantor belum disetting admin.", "error"); return; }
                    const distance = getDistanceFromLatLonInM(cur.lat, cur.lng, parseFloat(u.TargetLat), parseFloat(u.TargetLng));
                    if(distance > parseFloat(u.Radius)) {
                        showToast(`Gagal! Jarak ${Math.floor(distance)}m dari kantor (Max: ${u.Radius}m)`, "error");
                        return;
                    }
                }
                const video = $('webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                const photo = canvas.toDataURL('image/jpeg', 0.5);

                const payload = {
                    action: 'attendance', userId: this.data.currentUser.ID, name: this.data.currentUser.Name,
                    clockType: this.currentAction, lat: this.data.currentLocation.lat, lng: this.data.currentLocation.lng, photo: photo
                };

                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .then(() => {
                    showToast("Absen Berhasil!");
                    this.closeCamera();
                .catch(err => {  console.error("Gagal Kirim:", err);  showToast("Gagal menyimpan data. Cek console.", "error"); }
                    const list = $('history-list-absen');
                    const item = document.createElement('div');
                    item.style.padding = "10px 0"; item.style.borderBottom = "1px solid #eee";
                    item.innerHTML = `<b>${new Date().toLocaleTimeString()}</b> - ${this.currentAction} ‚úÖ`;
                    list.prepend(item);
                });
            },

            // --- ADMIN ---
            // --- PERBAIKAN SWITCH TAB ---
            switchTab: function(tab, btn) {
            // Hanya pilih elemen yang punya class 'tab-btn', jangan ganggu tombol lain
                const allTabs = document.querySelectorAll('.tab-btn');
                
            // Reset semua tab menjadi tampilan awal (Putih, Border Abu)
                allTabs.forEach(t => {
                    t.classList.remove('active');
            // Hapus style inline jika ada
                    t.style.background = ''; 
                    t.style.color = '';
                    t.style.borderColor = '';
                    t.style.boxShadow = '';
                    t.style.transform = '';
                });

            // Jadikan tombol yang diklik menjadi Aktif (Tambah class active)
                btn.classList.add('active');
                
           // Tampilkan content tab yang dipilih
                $('tab-employees').classList.add('hidden');
                $('tab-attendance').classList.add('hidden');
                $('tab-submissions').classList.add('hidden');
                
                $(`tab-${tab}`).classList.remove('hidden');
            },

            // 5. EDIT USER & RENDER
            renderEmployees: function() {
                const tbody = $('admin-emp-table').querySelector('tbody');
                tbody.innerHTML = this.data.users.map(u => `
                    <tr>
                        <td>${u.ID}</td><td>${u.Name}</td><td>${u.Role}</td><td>${u.WorkLocation || '-'}</td>
                        <td><span style="padding:2px 6px; border-radius:4px; background:${u.GPSMode==='terkunci'?'#fee2e2':'#d1fae5'}; color:${u.GPSMode==='terkunci'?'red':'green'}">${u.GPSMode || 'bebas'}</span></td>
                        <td>${u.TargetLat || 0}, ${u.TargetLng || 0}</td><td>${u.Radius || 0}m</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="app.openEditModal('${u.ID}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="app.deleteUser('${u.ID}')">Hapus</button>
                        </td>
                    </tr>
                `).join('');
            },
            
           // --- FITUR STATISTIK ADMIN ---
            renderStats: function(data) {
                // 1. Hitung Total Karyawan
                const totalEmp = this.data.users.filter(u => u.Role === 'employee').length;
                $('stat-total').textContent = totalEmp;

                // 2. Hitung Hadir / Tidak Hadir Hari Ini
                let todayAtt = [];
                if(data && data.attendance) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    // Filter absen hari ini
                    todayAtt = data.attendance.filter(r => r.Date.split('T')[0] === todayStr);
                }
                
                // Hitung unik user yang sudah Clock In
                const uniquePresent = [...new Set(todayAtt.map(r => r.UserID))];
                const presentCount = uniquePresent.length;
                const absentCount = totalEmp - presentCount;

                $('stat-present').textContent = presentCount;
                $('stat-absent').textContent = absentCount;

                // 3. Hitung Pengajuan Pending
                let pendingCount = 0;
                if(data && data.submissions) {
                    pendingCount = data.submissions.filter(r => r.Status === 'Pending').length;
                }
                $('stat-sub').textContent = pendingCount;
            },
            openEditModal: function(id) {
                const user = this.data.users.find(u => u.ID == id);
                if(!user) return;
                $('user-modal-title').textContent = "Edit Karyawan";
                $('old-id').value = user.ID;
                $('new-id').value = user.ID;
                $('new-name').value = user.Name;
                $('new-wa').value = user.WA || "";
                $('new-role').value = user.Role;
                $('new-workloc').value = user.WorkLocation || "";
                $('new-gpsmode').value = user.GPSMode || "bebas";
                $('new-lat').value = user.TargetLat || "";
                $('new-lng').value = user.TargetLng || "";
                $('new-radius').value = user.Radius || 100;
                
                this.toggleGpsInputs();
                $('btn-save-user').onclick = () => app.saveEditUser();
                $('user-modal').style.display = 'flex';
            },

            saveEditUser: function() {
                const payload = {
                    action: 'editUser',
                    oldId: $('old-id').value,
                    id: $('new-id').value, name: $('new-name').value, role: $('new-role').value, wa: $('new-wa').value,
                    workLocation: $('new-workloc').value, gpsMode: $('new-gpsmode').value,
                    targetLat: $('new-lat').value, targetLng: $('new-lng').value, radius: $('new-radius').value
                };
                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
			.then(() => { showToast("Absen Berhasil!"); this.closeCamera();
             // ... kode history ...
			})
			.catch(err => { console.error("Gagal Kirim:", err);
				showToast("Gagal menyimpan data. Cek console.", "error");
            });
        },

            showAddUserModal: function() {
                $('user-modal-title').textContent = "Tambah Karyawan";
                $('old-id').value = "";
                $('new-id').readOnly = false;
                $('new-id').value = ""; $('new-name').value = ""; $('new-wa').value = "";
                $('new-role').value = "employee"; $('new-workloc').value = "";
                $('new-gpsmode').value = "bebas"; $('new-lat').value = ""; $('new-lng').value = ""; $('new-radius').value = 100;
                this.toggleGpsInputs();
                $('btn-save-user').onclick = () => app.saveNewUser();
                $('user-modal').style.display = 'flex';
            },

            toggleGpsInputs: function() {
                const mode = $('new-gpsmode').value;
                if(mode === 'terkunci') $('gps-inputs').classList.remove('hidden');
                else $('gps-inputs').classList.add('hidden');
            },

            getCurrentLocForAdmin: function() {
                if(navigator.geolocation) {
                    $('new-lat').value = "Mencari...";
                    navigator.geolocation.getCurrentPosition(pos => {
                        $('new-lat').value = pos.coords.latitude;
                        $('new-lng').value = pos.coords.longitude;
                    });
                }
            },

            saveNewUser: function() {
                const payload = {
                    action: 'addUser',
                    id: $('new-id').value, name: $('new-name').value, role: $('new-role').value, wa: $('new-wa').value,
                    workLocation: $('new-workloc').value, gpsMode: $('new-gpsmode').value,
                    targetLat: $('new-lat').value, targetLng: $('new-lng').value, radius: $('new-radius').value
                };
                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .then(() => {
                    showToast("User Disimpan");
                    $('user-modal').style.display = 'none';
                    this.fetchUsers(() => { this.renderEmployees(); this.refreshData(); });
                });
            },

            deleteUser: function(id) {
                if(!confirm("Hapus user ini?")) return;
                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action:'deleteUser', id}) })
                .then(() => {
                    showToast("User Dihapus");
                    this.fetchUsers(() => { this.renderEmployees(); this.refreshData(); });
                });
            },

            // 6. FILTER & RENDER TABLES
            filterTable: function(tableId, colIndex, val) {
                const table = document.getElementById(tableId);
                const tr = table.getElementsByTagName("tr");
                val = val.toUpperCase();
                for (let i = 1; i < tr.length; i++) {
                    let td = tr[i].getElementsByTagName("td")[colIndex];
                    if (td) {
                        let txtValue = td.textContent || td.innerText;
                        tr[i].style.display = txtValue.toUpperCase().indexOf(val) > -1 ? "" : "none";
                    }
                }
            },

            renderSubmissions: function(data) {
                const tbody = $('admin-sub-table').querySelector('tbody');
                if(!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Belum ada pengajuan.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(row => {
                    const proofImg = (row.ProofURL && row.ProofURL !== "No Proof") 
                        ? `<a href="${row.ProofURL}" target="_blank"><img src="${row.ProofURL}" class="thumb-img"></a>` 
                        : '-';
                    
                    const statusColor = row.Status==='Approved'?'green':(row.Status==='Rejected'?'red':'orange');

                    // 7. TOLAK DENGAN ALASAN
                    const actions = (row.Status === 'Pending') ? `
                        <button class="btn btn-success btn-sm" onclick="app.updateSubmission('${row.UserID}', '${row.Date}', '${row.Name}', 'Approved')">Setuju</button>
                        <button class="btn btn-danger btn-sm" onclick="app.rejectSubmission('${row.UserID}', '${row.Date}', '${row.Name}')">Tolak</button>
                    ` : (row.Status === 'Rejected' ? `<small>${row.Reason||'-'}</small>` : '-');

                    return `
                    <tr>
                        <td>${row.Date}</td><td>${row.Name}</td><td>${row.Type}</td>
                        <td>${row.Desc.substring(0, 20)}...</td>
                        <td>${proofImg}</td>
                        <td><span style="color:${statusColor}; font-weight:bold;">${row.Status}</span></td>
                        <td>${actions}</td>
                    </tr>
                `}).join('');
            },

            updateSubmission: function(userId, date, name, status) {
                if(!confirm(`Ubah status menjadi ${status}?`)) return;
                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateSubmission', userId, date, name, newStatus: status, reason: '' }) })
                .then(() => { showToast("Status diperbarui"); this.refreshData(); });
            },

            rejectSubmission: function(userId, date, name) {
                const reason = prompt("Masukkan alasan penolakan:");
                if(reason !== null && reason !== "") {
                    fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateSubmission', userId, date, name, newStatus: 'Rejected', reason }) })
                    .then(() => { showToast("Status diperbarui"); this.refreshData(); });
                }
            },

            refreshData: function() {
                this.fetchUsers(() => this.renderEmployees());
                fetch(`${APP_SCRIPT_URL}?action=getData`).then(r=>r.json()).then(res => {
                    this.renderStats(res);
                    
                    // Attendance (With Filters)
                    let attData = res.attendance || [];
                    const fDate = $('filter-att-date').value;
                    const fMonth = $('filter-att-month').value;
                    
                    if(fDate) attData = attData.filter(r => new Date(r.Timestamp).toISOString().split('T')[0] === fDate);
                    if(fMonth) attData = attData.filter(r => new Date(r.Timestamp).toISOString().substring(0, 7) === fMonth);

                    $('admin-att-table').querySelector('tbody').innerHTML = attData.map(row => `
                        <tr><td>${new Date(row.Timestamp).toLocaleString()}</td><td>${row.Name}</td><td>${row.Type}</td><td>${row.Lat}, ${row.Lng}</td>
                        <td>${(row.PhotoURL && row.PhotoURL !== 'No Photo') ? `<a href="${row.PhotoURL}" target="_blank"><img src="${row.PhotoURL}" class="thumb-img"></a>` : '-'}</td>
                        </tr>
                    `).join('');

                    // Submissions (With Filters)
                    let subData = res.submissions || [];
                    const fStatus = $('filter-sub-status').value;
                    if(fStatus) subData = subData.filter(r => r.Status === fStatus);

                    this.renderSubmissions(subData);
                });
            },

            // --- IMPORT CSV ---
            handleImport: function(input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const rows = e.target.result.split('\n').map(r => r.trim()).filter(r => r.length > 0);
                    if (rows.length < 2) { showToast("File CSV salah", "error"); return; }
                    const data = [];
                    for(let i = 1; i < rows.length; i++) {
                        const cols = rows[i].split(',');
                        if(cols.length >= 2) data.push(cols.map(c => c.trim() || ""));
                    }
                    if(data.length > 0) app.sendImportData(data);
                };
                reader.readAsText(file); input.value = ""; 
            },
            sendImportData: function(dataArray) {
                const payload = { action: 'importUsers', users: dataArray };
                fetch(APP_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .then(() => { showToast("Import Berhasil!"); this.refreshData(); })
                .catch(err => showToast("Gagal Import.", "error"));
            }
        };

        $('sub-desc').addEventListener('input', function(e) { $('char-count').textContent = e.target.value.length + "/100 Karakter"; });
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
