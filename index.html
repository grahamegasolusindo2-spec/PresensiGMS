<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Presensi Modern - Graha Mega Solusindo</title>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* CSS VARIABLES */
        :root {
            --primary: #051650; 
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10B981; 
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --bg-app: #F3F4F6; 
            --surface: #FFFFFF;
            --text-main: #111827;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-app); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        
        .hidden { display: none !important; }
        
        .container { max-width: 480px; margin: 0 auto; padding: 0 20px; width: 100%; }
        .container.admin { max-width: 1000px; }

        .card { background: var(--surface); border-radius: var(--radius-md); padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 14px 20px; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; display: inline-flex; }

        .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
        .login-card { width: 100%; text-align: center; }
        
        .app-logo { width: 120px; height: auto; margin: 0 auto 20px; display: block; object-fit: contain; border-radius: 12px; }
        
        .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
            color: white;
            padding: 30px 20px 50px;
            border-radius: 0 0 30px 30px;
            margin-top: -20px;
            position: relative;
        }
        .profile-content { display: flex; align-items: center; gap: 15px; }
        .profile-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
        .profile-info h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; }
        .profile-info p { opacity: 0.9; font-size: 0.9rem; }
        
        .marquee-strip { background: #FEF3C7; color: #92400E; padding: 10px; border-radius: 12px; margin-top: -35px; position: relative; z-index: 10; box-shadow: var(--shadow); overflow: hidden; white-space: nowrap; font-size: 0.85rem; font-weight: 500; }
        .marquee-content { display: inline-block; animation: marquee 15s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 24px 0; }
        .clock-btn { height: 120px; flex-direction: column; font-size: 1.1rem; border-radius: 20px; }
        .clock-icon { font-size: 2rem; margin-bottom: 8px; }
        
        .history-item { display: flex; gap: 15px; padding: 16px 0; border-bottom: 1px solid #f3f4f6; }
        .history-time { text-align: right; min-width: 60px; }
        .history-time span { font-weight: 700; color: var(--primary); font-size: 1rem; }
        .history-time small { color: var(--text-muted); font-size: 0.75rem; }
        .history-content { flex: 1; }
        .history-status { font-weight: 600; margin-bottom: 4px; font-size: 0.95rem; }
        .history-loc { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: var(--radius-md); border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }

        .table-container { overflow-x: auto; background: white; border-radius: var(--radius-md); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #F9FAFB; text-align: left; padding: 12px 16px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }

        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 16px; border-radius: 50px; background: white; border: 1px solid var(--border); font-size: 0.9rem; font-weight: 500; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .admin-footer { margin-top: 40px; text-align: center; padding-top: 20px; border-top: 1px solid #E5E7EB; }
        .admin-footer .brand-name { font-size: 1.1rem; font-weight: 700; color: #374151; margin: 0 0 4px 0; }
        .admin-footer .support-text { font-size: 0.75rem; color: #9CA3AF; letter-spacing: 0.5px; margin: 0; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 24px; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        video { width: 100%; height: 250px; background: black; border-radius: 12px; object-fit: cover; transform: scaleX(-1); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; font-family: inherit; }
    </style>
</head>
<body>

    <!-- VIEW: LOGIN -->
    <section id="view-login" class="container">
        <div class="login-wrapper">
            
            <!-- FORM LOGIN -->
            <div id="form-login-container" class="login-card">
                <img src="https://i.imgur.com/xX4QN18.png" alt="Logo Perusahaan" class="app-logo">
                
                <h2 style="margin-bottom: 8px;">Selamat Datang</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Sistem Presensi Digital GMS</p>
                
                <div class="card" style="text-align: left; box-shadow: var(--shadow);">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">Nama Lengkap</label>
                        <input type="text" id="login-name" placeholder="Contoh: Budi Santoso">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 6px;">ID Pengguna</label>
                        <input type="text" id="login-id" placeholder="ID Anda (Contoh: K001)">
                    </div>
                    <button onclick="app.login()" class="btn btn-primary">Masuk Aplikasi</button>
                </div>
                
                <!-- Tombol Pindah ke Daftar -->
                <p style="margin-top: 20px; font-size: 0.9rem;">
                    Belum punya akun? 
                    <a href="#" onclick="app.toggleRegister()" style="color: var(--primary); font-weight: 600; text-decoration: none;">Daftar disini</a>
                </p>
            </div>

            <!-- FORM DAFTAR (Hidden by default) -->
            <div id="form-register-container" class="login-card hidden">
                <h2 style="margin-bottom: 20px;">Buat Akun Baru</h2>
                
                <div class="card" style="text-align: left; box-shadow: var(--shadow);">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Nama Lengkap</label>
                        <input type="text" id="reg-name" placeholder="Nama Lengkap Anda">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Buat ID Pengguna (Unik)</label>
                        <input type="text" id="reg-id" placeholder="Contoh: K003">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Kode Admin (Opsional)</label>
                        <input type="text" id="reg-code" placeholder="Isi jika Anda Admin">
                        <small style="color: var(--text-muted); font-size: 0.75rem;">*Biarkan kosong jika mendaftar sebagai Karyawan</small>
                    </div>
                    <button onclick="app.register()" class="btn btn-primary">Daftar Sekarang</button>
                </div>

                <!-- Tombol Kembali -->
                <p style="margin-top: 20px; font-size: 0.9rem;">
                    Sudah punya akun? 
                    <a href="#" onclick="app.toggleRegister()" style="color: var(--primary); font-weight: 600; text-decoration: none;">Login disini</a>
                </p>
            </div>
        </div>

        <div class="admin-footer">
            <p class="brand-name">Graha Mega Solusindo</p>
            <p class="support-text">supported by: Klase Auto Graha</p>
        </div>
    </section>

    <!-- VIEW: EMPLOYEE -->
    <section id="view-employee" class="container hidden">
        <div class="profile-header">
            <div class="profile-content">
                <img id="emp-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="profile-avatar">
                <div class="profile-info">
                    <h2 id="emp-name">Nama User</h2>
                    <p id="emp-role">Karyawan</p>
                </div>
                <div style="margin-left: auto;">
                    <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">ID: <span id="emp-id">123</span></span>
                </div>
            </div>
        </div>

        <div class="marquee-strip">
            <div class="marquee-content">
                ‚ö†Ô∏è Ingat! Clock In maksimal jam 09:00 WIB.  |  Pastikan Anda berada di dalam radius kantor saat absen.  |  Gunakan fitur Pengajuan jika tidak masuk kerja.
            </div>
        </div>

        <div class="clock-grid">
            <button onclick="app.openCamera('Masuk')" class="btn btn-success clock-btn">
                <span class="clock-icon">üì•</span>
                Clock In
            </button>
            <button onclick="app.openCamera('Pulang')" class="btn btn-danger clock-btn">
                <span class="clock-icon">üì§</span>
                Clock Out
            </button>
        </div>

        <div class="card" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px;">
            <div id="gps-dot" style="width: 10px; height: 10px; background: #ccc; border-radius: 50%;"></div>
            <div style="flex: 1;">
                <div style="font-size: 0.9rem; font-weight: 600;" id="gps-status-text">Menunggu Lokasi...</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);" id="gps-coords">Lat: -, Lng: -</div>
            </div>
        </div>

        <div class="card" style="padding: 0;">
            <div onclick="document.getElementById('sub-form').classList.toggle('hidden')" style="padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6;">
                <span style="font-weight: 600;">üìÑ Ajukan Izin / Sakit</span>
                <span>‚ñº</span>
            </div>
            <div id="sub-form" class="hidden" style="padding: 20px; background: #f9fafb;">
                <select id="sub-type">
                    <option>Sakit</option>
                    <option>Izin</option>
                    <option>Cuti</option>
                    <option value="Luar Kota">Luar Kota</option>
                </select>
                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Tanggal Pengajuan</label>
                <input type="date" id="sub-date">
                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Keterangan</label>
                <textarea id="sub-desc" placeholder="Tulis keterangan..."></textarea>
                <button onclick="app.submitPengajuan()" class="btn btn-primary btn-sm">Kirim Pengajuan</button>
            </div>
        </div>

        <h3 style="margin: 20px 0 12px; font-size: 1.1rem;">Riwayat & Status</h3>
        <div class="card" style="padding-top: 10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px;">
                <button id="tab-hist-absen" onclick="app.switchHistory('absen')" class="btn btn-sm" style="background: var(--primary); color: white; border: none; flex: 1;">Riwayat Absen</button>
                <button id="tab-hist-sub" onclick="app.switchHistory('pengajuan')" class="btn btn-sm" style="background: white; color: var(--text-muted); border: 1px solid var(--border); flex: 1;">Riwayat Pengajuan</button>
            </div>
            <div id="view-absen">
                <div id="history-list-absen">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Memuat riwayat absen...</div>
                </div>
            </div>
            <div id="view-pengajuan" class="hidden">
                <div id="history-list-sub">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Belum ada pengajuan.</div>
                </div>
            </div>
        </div>

        <button onclick="app.logout()" class="btn btn-outline" style="border-color: #fee2e2; color: var(--danger);">Keluar Aplikasi</button>
    </section>

    <!-- VIEW: ADMIN -->
    <section id="view-admin" class="container admin hidden">
        <div class="admin-header">
            <h2>Dashboard Admin</h2>
            <button onclick="app.logout()" class="btn btn-sm btn-danger">Keluar</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="stat-total">0</div>
                <div class="stat-label">Total Karyawan</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="stat-present" style="color: var(--success);">0</div>
                <div class="stat-label">Hadir Hari Ini</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="stat-sub" style="color: var(--warning);">0</div>
                <div class="stat-label">Pengajuan Pending</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="app.switchAdminTab('attendance', this)">Rekap Absen</div>
            <div class="tab-btn" onclick="app.switchAdminTab('employees', this)">Kelola Karyawan</div>
            <div class="tab-btn" onclick="app.switchAdminTab('submissions', this)">Pengajuan</div>
        </div>

        <div id="tab-attendance">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 16px; background: #f9fafb; display: flex; gap: 10px; border-bottom: 1px solid var(--border);">
                    <input type="date" id="filter-date" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px;">
                    <button onclick="app.exportExcel()" class="btn btn-success btn-sm">üì• Excel</button>
                </div>
                <div class="table-container">
                    <table id="admin-att-table">
                        <thead><tr><th>Waktu</th><th>Nama</th><th>Tipe</th><th>Lokasi</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-employees" class="hidden">
            <div class="card">
                <h3>Tambah Karyawan</h3>
                <input type="text" id="new-emp-id" placeholder="ID Karyawan (Misal: K003)">
                <input type="text" id="new-emp-name" placeholder="Nama Lengkap">
                <button onclick="app.addEmployee()" class="btn btn-primary">Simpan Data</button>
            </div>
            <div class="card">
                <h3>Daftar Karyawan</h3>
                <div class="table-container">
                    <table id="emp-table">
                        <thead><tr><th>ID</th><th>Nama</th><th>Role</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-submissions" class="hidden">
            <div class="card">
                <h3>Daftar Pengajuan Masuk</h3>
                <div id="admin-sub-list"></div>
            </div>
        </div>

        <div class="admin-footer">
            <p class="brand-name">Graha Mega Solusindo</p>
            <p class="support-text">supported by: Klase Auto Graha</p>
        </div>
    </section>

    <!-- MODAL KAMERA -->
    <div id="modal-camera" class="modal-overlay">
        <div class="modal-box">
            <h3>Ambil Foto Selfie</h3>
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button onclick="app.closeCamera()" class="btn btn-danger btn-sm">Batal</button>
                <button onclick="app.capturePhoto()" class="btn btn-primary btn-sm">üì∏ Ambil & Kirim</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // --- KONFIGURASI SUPABASE ---
        // PASTIKAN ANDA MENGISI DUA BAGIAN INI
        const SUPABASE_URL = 'https://vvanhknwizwxlvznbesg.supabase.com'; 
        const SUPABASE_KEY = 'sb_publishable_tLMaZcX3Dmgz9E1YeoxYYw_Cd7aWaol';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const app = {
            currentUser: null,
            currentRole: null,
            videoStream: null,
            photoData: null,
            clockActionType: null,

            // --- AUTH & REGISTER ---
            login: async function() {
                const name = document.getElementById('login-name').value;
                const id = document.getElementById('login-id').value;

                if(!name || !id) return alert("Mohon isi nama dan ID!");

                if(id.toLowerCase() === 'gms001') {
                    this.currentUser = { id: 'gms001', full_name: 'Administrator', role: 'admin' };
                    this.currentRole = 'admin';
                    this.showView('admin');
                    this.loadAdminDashboard();
                    return;
                }

                const { data, error } = await supabase.from('profiles').select('*').eq('id', id).single();
                
                if (error || !data) {
                    alert("ID Karyawan tidak ditemukan! Silakan daftar atau hubungi Admin.");
                } else {
                    if(data.full_name !== name) {
                        await supabase.from('profiles').update({full_name: name}).eq('id', id);
                        data.full_name = name;
                    }
                    this.currentUser = data;
                    this.currentRole = 'employee';
                    this.showView('employee');
                    this.initEmployee();
                }
            },

            logout: function() {
                this.currentUser = null;
                this.currentRole = null;
                document.getElementById('view-login').classList.remove('hidden');
                document.getElementById('view-employee').classList.add('hidden');
                document.getElementById('view-admin').classList.add('hidden');
            },

            toggleRegister: function() {
                const loginForm = document.getElementById('form-login-container');
                const regForm = document.getElementById('form-register-container');
                
                if (loginForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                    regForm.classList.add('hidden');
                } else {
                    loginForm.classList.add('hidden');
                    regForm.classList.remove('hidden');
                }
            },

            register: async function() {
                const name = document.getElementById('reg-name').value;
                const id = document.getElementById('reg-id').value;
                const code = document.getElementById('reg-code').value;

                if(!name || !id) {
                    return alert("Mohon isi Nama dan ID Pengguna!");
                }

                let role = 'employee';
                if (code === 'GMS2024') { 
                    role = 'admin'; 
                }

                const { error } = await supabase.from('profiles').insert([{
                    id: id, 
                    full_name: name, 
                    role: role
                }]);

                if (error) {
                    if (error.code === '23505') {
                        alert("Gagal! ID Pengguna ini sudah terdaftar.");
                    } else {
                        alert("Terjadi kesalahan: " + error.message);
                    }
                } else {
                    alert(`Pendaftaran Berhasil!\nRole: ${role.toUpperCase()}\nSilakan Login.`);
                    document.getElementById('reg-name').value = '';
                    document.getElementById('reg-id').value = '';
                    document.getElementById('reg-code').value = '';
                    this.toggleRegister();
                }
            },

            showView: function(viewName) {
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-employee').classList.add('hidden');
                document.getElementById('view-admin').classList.add('hidden');
                document.getElementById('view-' + viewName).classList.remove('hidden');
            },

            // --- EMPLOYEE LOGIC ---
            initEmployee: function() {
                document.getElementById('emp-name').innerText = this.currentUser.full_name;
                document.getElementById('emp-id').innerText = this.currentUser.id;
                document.getElementById('emp-avatar').src = `https://ui-avatars.com/api/?name=${this.currentUser.full_name}`;
                this.getLocation();
                this.loadHistory('absen');
                this.loadHistory('pengajuan');
            },

            getLocation: function() {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition((pos) => {
                        const lat = pos.coords.latitude.toFixed(5);
                        const lng = pos.coords.longitude.toFixed(5);
                        document.getElementById('gps-status-text').innerText = "GPS Aktif (Terkunci)";
                        document.getElementById('gps-status-text').style.color = "var(--success)";
                        document.getElementById('gps-dot').style.background = "var(--success)";
                        document.getElementById('gps-coords').innerText = `Lat: ${lat}, Lng: ${lng}`;
                        this.currentUser.lat = lat;
                        this.currentUser.lng = lng;
                    }, (err) => {
                        document.getElementById('gps-status-text').innerText = "GPS Gagal";
                        document.getElementById('gps-status-text').style.color = "var(--danger)";
                    });
                }
            },

            openCamera: async function(type) {
                this.clockActionType = type;
                const modal = document.getElementById('modal-camera');
                const video = document.getElementById('camera-feed');
                modal.style.display = 'flex';
                
                try {
                    this.videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    video.srcObject = this.videoStream;
                } catch(e) {
                    alert("Gagal akses kamera: " + e.message);
                    this.closeCamera();
                }
            },

            closeCamera: function() {
                const modal = document.getElementById('modal-camera');
                modal.style.display = 'none';
                if(this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                }
            },

            capturePhoto: function() {
                const video = document.getElementById('camera-feed');
                const canvas = document.getElementById('camera-canvas');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                this.photoData = canvas.toDataURL('image/jpeg');
                this.closeCamera();
                this.submitAttendance();
            },

            submitAttendance: async function() {
                const address = `Lat:${this.currentUser.lat}, Lng:${this.currentUser.lng}`;

                const { error } = await supabase.from('attendances').insert([{
                    user_id: this.currentUser.id,
                    type: this.clockActionType,
                    lat: this.currentUser.lat,
                    lng: this.currentUser.lng,
                    address: address,
                    photo_url: 'https://ui-avatars.com/api/?name=Foto',
                    status: 'Hadir'
                }]);

                if(error) alert("Gagal: " + error.message);
                else {
                    alert(`Berhasil ${this.clockActionType}!`);
                    this.loadHistory('absen');
                }
            },

            submitPengajuan: async function() {
                const type = document.getElementById('sub-type').value;
                const date = document.getElementById('sub-date').value;
                const desc = document.getElementById('sub-desc').value;

                if(!date || !desc) return alert("Lengkapi data!");

                await supabase.from('submissions').insert([{
                    user_id: this.currentUser.id,
                    type, date_val: date, description: desc
                }]);

                alert("Pengajuan terkirim!");
                this.loadHistory('pengajuan');
                document.getElementById('sub-form').classList.add('hidden');
            },

            loadHistory: async function(tab) {
                let data, error;
                if(tab === 'absen') {
                    const res = await supabase.from('attendances').select('*').eq('user_id', this.currentUser.id).order('clock_in', { ascending: false });
                    data = res.data; error = res.error;
                    const list = document.getElementById('history-list-absen');
                    list.innerHTML = data.map(item => `
                        <div class="history-item">
                            <div class="history-time">
                                <span>${new Date(item.clock_in).getHours()}:${new Date(item.clock_in).getMinutes()}</span>
                                <small>${new Date(item.clock_in).toLocaleDateString()}</small>
                            </div>
                            <div class="history-content">
                                <div class="history-status">${item.type} - ${item.status}</div>
                                <div class="history-loc">üìç ${item.address}</div>
                            </div>
                        </div>
                    `).join('') || '<div style="text-align:center;padding:20px;color:#999">Belum absen hari ini</div>';
                } else {
                    const res = await supabase.from('submissions').select('*').eq('user_id', this.currentUser.id).order('id', { ascending: false });
                    data = res.data; error = res.error;
                    const list = document.getElementById('history-list-sub');
                    list.innerHTML = data.map(item => `
                        <div class="history-item">
                            <div class="history-time">
                                <span>${item.type}</span>
                                <small>${item.date_val}</small>
                            </div>
                            <div class="history-content">
                                <div class="history-status" style="color:${item.status === 'Approved' ? 'green' : 'orange'}">${item.status}</div>
                                <div>${item.description}</div>
                            </div>
                        </div>
                    `).join('') || '<div style="text-align:center;padding:20px;color:#999">Belum ada pengajuan</div>';
                }
            },

            switchHistory: function(tab) {
                document.getElementById('view-absen').classList.add('hidden');
                document.getElementById('view-pengajuan').classList.add('hidden');
                document.getElementById('tab-hist-absen').classList.remove('active');
                document.getElementById('tab-hist-absen').style.background = 'white';
                document.getElementById('tab-hist-absen').style.color = 'var(--text-muted)';
                
                document.getElementById('tab-hist-sub').classList.remove('active');
                document.getElementById('tab-hist-sub').style.background = 'white';
                document.getElementById('tab-hist-sub').style.color = 'var(--text-muted)';

                if(tab === 'absen') {
                    document.getElementById('view-absen').classList.remove('hidden');
                    document.getElementById('tab-hist-absen').classList.add('active');
                    document.getElementById('tab-hist-absen').style.background = 'var(--primary)';
                    document.getElementById('tab-hist-absen').style.color = 'white';
                } else {
                    document.getElementById('view-pengajuan').classList.remove('hidden');
                    document.getElementById('tab-hist-sub').classList.add('active');
                    document.getElementById('tab-hist-sub').style.background = 'var(--primary)';
                    document.getElementById('tab-hist-sub').style.color = 'white';
                }
            },

            // --- ADMIN LOGIC ---
            loadAdminDashboard: async function() {
                const { count: totalEmp } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
                document.getElementById('stat-total').innerText = totalEmp || 0;
                this.loadAdminAttendance();
                this.loadEmployeeList();
                this.loadSubmissions();
            },

            loadAdminAttendance: async function() {
                const { data } = await supabase.from('attendances').select('*, profiles(full_name)').order('clock_in', { ascending: false }).limit(50);
                const tbody = document.querySelector('#admin-att-table tbody');
                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td>${new Date(row.clock_in).toLocaleString()}</td>
                        <td>${row.profiles.full_name}</td>
                        <td>${row.type}</td>
                        <td>${row.lat ? row.lat.toFixed(4) : '-'}</td>
                        <td><span style="background:${row.type==='Masuk'?'#d1fae5':'#fee2e2'}; padding:2px 8px; border-radius:4px; font-size:0.8rem">${row.status}</span></td>
                    </tr>
                `).join('');
            },

            loadEmployeeList: async function() {
                const { data } = await supabase.from('profiles').select('*').neq('role', 'admin');
                const tbody = document.querySelector('#emp-table tbody');
                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td>${row.id}</td>
                        <td>${row.full_name}</td>
                        <td>${row.role}</td>
                    </tr>
                `).join('');
            },

            addEmployee: async function() {
                const id = document.getElementById('new-emp-id').value;
                const name = document.getElementById('new-emp-name').value;
                if(!id || !name) return alert("Isi data!");

                await supabase.from('profiles').insert([{ id, full_name: name, role: 'employee' }]);
                alert("Karyawan ditambahkan!");
                this.loadEmployeeList();
                document.getElementById('new-emp-id').value = '';
                document.getElementById('new-emp-name').value = '';
            },

            loadSubmissions: async function() {
                const { data } = await supabase.from('submissions').select('*, profiles(full_name)').eq('status', 'Pending');
                const list = document.getElementById('admin-sub-list');
                list.innerHTML = data.map(item => `
                    <div class="card" style="padding:15px; border-left: 4px solid var(--warning);">
                        <strong>${item.profiles.full_name}</strong> (${item.type}) - ${item.date_val}<br>
                        <small>${item.description}</small><br>
                        <div style="margin-top:5px;">
                            <button onclick="app.approveSub(${item.id})" class="btn btn-sm btn-success">Setuju</button>
                            <button onclick="app.rejectSub(${item.id})" class="btn btn-sm btn-danger">Tolak</button>
                        </div>
                    </div>
                `).join('') || '<p style="text-align:center">Tidak ada pending.</p>';
            },

            approveSub: async function(id) {
                await supabase.from('submissions').update({ status: 'Approved' }).eq('id', id);
                this.loadSubmissions();
            },

            rejectSub: async function(id) {
                await supabase.from('submissions').update({ status: 'Rejected' }).eq('id', id);
                this.loadSubmissions();
            },

            switchAdminTab: function(tab, el) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
                
                document.getElementById('tab-attendance').classList.add('hidden');
                document.getElementById('tab-employees').classList.add('hidden');
                document.getElementById('tab-submissions').classList.add('hidden');
                
                document.getElementById('tab-' + tab).classList.remove('hidden');
            },

            exportExcel: function() {
                const table = document.getElementById('admin-att-table');
                const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet 1"});
                XLSX.writeFile(wb, 'Rekap_Absensi_GMS.xlsx');
            }
        };
    </script>
</body>
</html>

